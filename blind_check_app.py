import streamlit as st
import re
import fitz  # PyMuPDF

# ë¸”ë¼ì¸ë“œ ì±„ìš© ê¸°ì¤€ ìœ„ë°˜ í•­ëª© ì •ì˜
VIOLATION_RULES = {
    "ì¶œì‹ ì§€ì—­": [
        "ê³ í–¥", "ì¶œì‹ ì§€",
        "ì„œìš¸", "ë¶€ì‚°", "ì¸ì²œ", "ëŒ€êµ¬", "ê´‘ì£¼", "ëŒ€ì „", "ì„¸ì¢…", "ìš¸ì‚°", "ì œì£¼",
        "ê²½ê¸°ë„", "ê°•ì›ë„", "ì¶©ì²­ë¶ë„", "ì¶©ì²­ë‚¨ë„", "ì „ë¼ë¶ë„", "ì „ë¼ë‚¨ë„", 
        "ê²½ìƒë¶ë„", "ê²½ìƒë‚¨ë„", "ì œì£¼ë„", "ì„œìš¸íŠ¹ë³„ì‹œ", "ë¶€ì‚°ê´‘ì—­ì‹œ", "ëŒ€êµ¬ê´‘ì—­ì‹œ",
        "ì¸ì²œê´‘ì—­ì‹œ", "ê´‘ì£¼ê´‘ì—­ì‹œ", "ëŒ€ì „ê´‘ì—­ì‹œ", "ìš¸ì‚°ê´‘ì—­ì‹œ", "ì„¸ì¢…íŠ¹ë³„ìì¹˜ì‹œ",
        r"[ê°€-í£]{2,10}(ì‹œ|ë„|êµ°|êµ¬|ì|ë©´)"
    ],
    "ê°€ì¡±ê´€ê³„": [
        "ì•„ë²„ì§€", "ì–´ë¨¸ë‹ˆ", "ë¶€ëª¨ë‹˜", "í˜•", "ëˆ„ë‚˜", "ì˜¤ë¹ ", "ì–¸ë‹ˆ", "ë™ìƒ", "ê°€ì¡±"
    ],
    "ì¢…êµ": [
        "êµíšŒ", "ì„±ë‹¹", "ë¶ˆêµ", "ê¸°ë…êµ", "ì²œì£¼êµ", "ì²­ë…„ë¶€", "ê¸°ë„íšŒ", "ì˜ˆë°°", "ì¢…êµ"
    ],
    "ì •ì¹˜": [
        "ë”ë¶ˆì–´ë¯¼ì£¼ë‹¹", "êµ­ë¯¼ì˜í˜", "ë³´ì¢Œê´€", "êµ­íšŒì˜ì›", "ì •ë‹¹", "ì •ì¹˜"
    ],
    "ì—°ë ¹": [
        r"\d{2}ì„¸", r"\d{2}ì‚´", "20ëŒ€", "30ëŒ€", "40ëŒ€", "í•œì¼ ì›”ë“œì»µ", "90ë…„ëŒ€ìƒ", "2000ë…„ìƒ"
    ],
    "ì„±ë³„": [
    "ë‚¨ì", "ì—¬ì", "ì•„ë¹ ", "ì—„ë§ˆ", "ì„ì‹ ", "ìœ¡ì•„", "í˜„ì—­", "ë³µë¬´", "êµ°ëŒ€",
    # êµ° ë³µë¬´ ê´€ë ¨ í‚¤ì›Œë“œ ì¶”ê°€
    "í–‰ì •ë³‘", "ìš´ì „ë³‘", "í†µì‹ ë³‘", "ë³´ë³‘", "ì´ë³‘", "ì¼ë³‘", "ìƒë³‘", "ë³‘ì¥",
    "ìœ¡êµ°", "í•´êµ°", "ê³µêµ°", "í•´ë³‘ëŒ€", "ì „ì—­", "êµ°ìƒí™œ", "êµ°ë²ˆ", "ìëŒ€", "ì¡°êµ", "í›ˆë ¨ì†Œ", "GOP", "ROTC"
    ],
    "ì¶œì‹ í•™êµ": [
        r"(?![Oâ—‹]+ëŒ€)[ê°€-í£]{2,10}ëŒ€",
        r"[ê°€-í£]{2,10}ëŒ€í•™êµ",
        "ê³ ë“±í•™êµ", "ì¤‘í•™êµ"
    ]
}

# ìœ„ë°˜ í•­ëª© ê°ì§€ í•¨ìˆ˜
def detect_violations(text):
    results = []
    for category, patterns in VIOLATION_RULES.items():
        for pattern in patterns:
            matches = re.findall(pattern, text)
            for match in matches:
                results.append((category, match))
    return results

# Streamlit UI
st.title("ğŸ” NRC ìê¸°ì†Œê°œì„œ ë¸”ë¼ì¸ë“œ ì²´í¬ê¸°")
st.write("ê²½ì œì¸ë¬¸ì‚¬íšŒì—°êµ¬íšŒ ìê¸°ì†Œê°œì„œì—ì„œ ë¸”ë¼ì¸ë“œ ì±„ìš© ê¸°ì¤€ ìœ„ë°˜ í•­ëª©ì´ í¬í•¨ë˜ì—ˆëŠ”ì§€ ìë™ìœ¼ë¡œ ì ê²€í•©ë‹ˆë‹¤.")
with st.expander("ğŸ“Œ ë¸”ë¼ì¸ë“œ ì±„ìš© ê¸°ì¤€ ë³´ê¸° (í´ë¦­í•˜ì—¬ í¼ì¹˜ê¸°/ë‹«ê¸°)"):
    st.image("blind_guideline_sample.png", caption="ê²½ì œì¸ë¬¸ì‚¬íšŒì—°êµ¬íšŒ ë¸”ë¼ì¸ë“œ ì±„ìš© ê¸°ì¤€ ìš”ì•½", use_container_width=True)


tab1, tab2 = st.tabs(["ğŸ“„ ì§ì ‘ ì…ë ¥", "ğŸ“ PDF ì—…ë¡œë“œ"])

with tab1:
    user_input = st.text_area("ìê¸°ì†Œê°œì„œ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”", height=300)

    if st.button("ì§ì ‘ ì…ë ¥ ê²€ì‚¬í•˜ê¸°"):
        if not user_input.strip():
            st.warning("ìê¸°ì†Œê°œì„œ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.")
        else:
            violations = detect_violations(user_input)
            if violations:
                st.error("â— ë‹¤ìŒ í•­ëª©ë“¤ì´ ë¸”ë¼ì¸ë“œ ì±„ìš© ê¸°ì¤€ì„ ìœ„ë°˜í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:")
                for category, keyword in set(violations):
                    st.markdown(f"- **[{category}]** í‚¤ì›Œë“œ ë°œê²¬: `{keyword}`")
            else:
                st.success("âœ… ìœ„ë°˜ ìš”ì†Œê°€ ì—†ìŠµë‹ˆë‹¤. ì•ˆì „í•œ ìê¸°ì†Œê°œì„œì…ë‹ˆë‹¤.")

with tab2:
    uploaded_file = st.file_uploader("ìê¸°ì†Œê°œì„œ PDF íŒŒì¼ ì—…ë¡œë“œ", type="pdf")

    if uploaded_file is not None:
        doc = fitz.open(stream=uploaded_file.read(), filetype="pdf")
        extracted_text = ""
        for page in doc:
            extracted_text += page.get_text()
        
        st.text_area("ğŸ“„ ì¶”ì¶œëœ ìê¸°ì†Œê°œì„œ ë‚´ìš©", extracted_text, height=300)

        if st.button("PDF ë‚´ìš© ê²€ì‚¬í•˜ê¸°"):
            if not extracted_text.strip():
                st.warning("PDFì—ì„œ ë‚´ìš©ì„ ì¶”ì¶œí•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.")
            else:
                violations = detect_violations(extracted_text)
                if violations:
                    st.error("â— ë‹¤ìŒ í•­ëª©ë“¤ì´ ë¸”ë¼ì¸ë“œ ì±„ìš© ê¸°ì¤€ì„ ìœ„ë°˜í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:")
                    for category, keyword in set(violations):
                        st.markdown(f"- **[{category}]** í‚¤ì›Œë“œ ë°œê²¬: `{keyword}`")
                else:
                    st.success("âœ… ìœ„ë°˜ ìš”ì†Œê°€ ì—†ìŠµë‹ˆë‹¤. ì•ˆì „í•œ ìê¸°ì†Œê°œì„œì…ë‹ˆë‹¤.")
